.. title:: Webhooks integration

.. toctree::
    :maxdepth: 2


.. _webhooks:

Webhooks integration
====================

Webhooks allow you to easily automate your deployment workflows by integrating third party git providers with Cloud Deploy (Ghost)!

See `Available Providers`_ section for currently supported providers.

Create a webhook configuration using Cloud Deploy UI:
-----------------------------------------------------

    1. Create a webhook configuration on Cloud Deploy webhooks page.
    2. Fill the form:

        * Application ID: select the Cloud Deploy application to use,
        * Module name: select the appropriate module, it must correspond to the git repository you will use to trigger the webhook
        * Revision regex: regex must match expected revision. This can be a branch, a tag or a specific commit hash
        * Secret token: secure the webhook by adding a token of your choice (supported on Github and Gitlab),
        * Events: list of events that should trigger the webhook. By default the ``push`` event should be enough for most scenarios
        * Command to run: deploy or buildimage. All other fields are depending on the command to run.

    3. Create a webhook on the external service you are using to trigger webhooks (Github, for instance). You'll need to copy paste the URL generated by Cloud Deploy.
    4. (Optional) Ensure the IP addresses of your third party webhook service provider are authorized to reach you Cloud Deploy endpoint, contact your administrator if needed. Refer to `Available Providers`_ section for more information about those IPs.
    5. Your webhook is ready!

You can also create this webhook configuration via the :ref:`CLI (Casper) <cli>`, via :ref:`API <api>` or the Terraform provider.

Configure webhook integration on a git provider
-----------------------------------------------

Go to repository settings - webhooks page on your Github, Bitbucket or Gitlab repository.

**Github settings**

.. figure:: /images/webhook_github.png
    :scale: 90%

**Bitbucket settings**

.. figure:: /images/webhook_bitbucket.png
    :scale: 60 %

**Gitlab settings**

.. figure:: /images/webhook_gitlab.png
    :scale: 75 %

**Legend:**

    1. Paste URL we previously copied from Cloud Deploy,
    2. Select application/json,
    3. Empty if no secret token defined, otherwise the token defined in your configuration,
    4. Select events you want to trigger the webhook on,
    5. Activate call history and add webhook

It is now ready! Selected events of this repo will trigger a new deployment or buildimage of your Cloud Deploy module!

Available Providers
-------------------
+------------+------------------+----------------------------+--------------+
| Provider   | Supported Events | IPs to whitelist           | Secret token |
+============+==================+============================+==============+
| Github     | * push           | * 140.82.112.0/20          | yes          |
|            | * tag            | * 192.30.252.0/22          |              |
|            | * merge          | * 185.199.108.0/22         |              |
|            |                  |                            |              |
|            |                  | Visit `Github IPs`_ page   |              |
|            |                  | for up-to-date information.|              |
+------------+------------------+----------------------------+--------------+
| Bitbucket  | * push           | * 104.192.136.0/21         | no           |
|            | * tag            | * 34.198.32.85             |              |
|            | * merge          | * 34.198.203.127           |              |
|            |                  | * 34.198.178.64            |              |
|            |                  |                            |              |
|            |                  | Visit `Bitbucket IPs`_ page|              |
|            |                  | for up-to-date information.|              |
+------------+------------------+----------------------------+--------------+
| Gitlab     | * push           | Not available at the time  | yes          |
|            | * tag            | of writing.                |              |
|            | * merge          | See `Gitlab issue`_.       |              |
+------------+------------------+----------------------------+--------------+

.. _Github IPs: https://api.github.com/meta
.. _Bitbucket IPs: https://confluence.atlassian.com/bitbucket/what-are-the-bitbucket-cloud-ip-addresses-i-should-use-to-configure-my-corporate-firewall-343343385.html
.. _Gitlab issue: https://gitlab.com/gitlab-com/gl-infra/infrastructure/issues/434
