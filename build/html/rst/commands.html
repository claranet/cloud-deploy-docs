

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Ghost Commands &mdash; Claranet Ghost 16.12 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/ghost-doc.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Claranet Ghost 16.12 documentation" href="../index.html"/>
        <link rel="next" title="Ghost Scripts" href="scripts.html"/>
        <link rel="prev" title="Ghost API" href="api.html"/>
 <script type="text/javascript">
  window.addEventListener("load", function load() {
    window.removeEventListener("load", load, false);
    var links = document.querySelectorAll("#openapi-specification > p.swagger-ui-link > a");
    if (links) {
      for (var i = 0; i < links.length; ++i) {
        links[i].href = "https://api.ghost.morea.fr/swagger-ui/index.html?url=" + window.location.origin + "/docs/api";
      }
    }
  });
 </script>


  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Claranet Ghost
          

          
            
            <img src="../_static/logo_ghost.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                16.12
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick-start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Ghost Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Ghost API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Ghost Commands</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#build-buildimage">Build | buildimage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-updatelifecyclehooks">Build | updatelifecyclehooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-createinstance">Build | createinstance</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-destroyallinstances">Build | destroyallinstances</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-build-updateautoscaling">Run/Build | updateautoscaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-deploy">Run | deploy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#safe-deploy-documentation">Safe deploy documentation:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#run-redeploy">Run | redeploy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#blue-green-preparebluegreen">Blue/Green | preparebluegreen</a></li>
<li class="toctree-l2"><a class="reference internal" href="#blue-green-swapbluegreen">Blue/Green | swapbluegreen</a></li>
<li class="toctree-l2"><a class="reference internal" href="#blue-green-purgebluegreen">Blue/Green | purgebluegreen</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="scripts.html">Ghost Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="ui.html">Web User Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Casper: CLI client</a></li>
<li class="toctree-l1"><a class="reference internal" href="bluegreen.html">Blue/Green Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="matrix.html">Feature matrix comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Ghost Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Claranet Ghost</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Ghost Commands</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/rst/commands.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ghost-commands">
<span id="commands"></span><h1>Ghost Commands<a class="headerlink" href="#ghost-commands" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="build-buildimage">
<h2>Build | buildimage<a class="headerlink" href="#build-buildimage" title="Permalink to this headline">¶</a></h2>
<p>This command should be the first one triggered after a Ghost Application creation.
It bakes a new AMI with every feature specified in the application on top of the source AMI choosen. (Generally a Morea Debian AMI)
Morea uses SaltStack to provision all the choosen features and uses Packer (from HashiCorp) to bake the new AMI.</p>
<p><strong>Command Options</strong></p>
<dl class="docutils">
<dt><em>Instance Type</em> :</dt>
<dd><blockquote class="first">
<div><code class="docutils literal"><span class="pre">string</span></code></div></blockquote>
<p class="last">Choose the instance type of the temporary instance created by Packer for provisionning.</p>
</dd>
<dt><em>Skip SALT bootstrap</em> :</dt>
<dd><blockquote class="first">
<div><code class="docutils literal"><span class="pre">boolean</span></code></div></blockquote>
<p class="last">This option permits to choose if Packer should install the Salt agent (minion) before applying all feature formulas.</p>
</dd>
</dl>
<p><strong>Life cycle hooks</strong></p>
<blockquote>
<div><p>There are two Hooks available and configurable in the application.
Thoose hooks are scripts:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">pre_buildimage</span></code> : Script executed on the temporary instance <em>before</em> the SALT provisionning</li>
<li><code class="docutils literal"><span class="pre">post_buildimage</span></code> : Script executed on the temporary instance <em>after</em> the SALT provisionning</li>
</ul>
</div></blockquote>
</div></blockquote>
<div class="figure">
<img alt="../_images/ghost_buildimage.png" src="../_images/ghost_buildimage.png" />
</div>
<div class="figure">
<img alt="../_images/buildimage_workflow.png" src="../_images/buildimage_workflow.png" />
</div>
</div>
<div class="section" id="build-updatelifecyclehooks">
<h2>Build | updatelifecyclehooks<a class="headerlink" href="#build-updatelifecyclehooks" title="Permalink to this headline">¶</a></h2>
<p>This command allows you to upload and upgrade the pre-bootstrap and post-bootstrap scripts defined in the application.
Those scripts will be executed when a new instance is create by the auto-scaling group or when the <code class="docutils literal"><span class="pre">createinstance</span></code> command is triggered in Ghost.</p>
<p>Here is a workflow diagram for more details :</p>
<div class="figure">
<img alt="../_images/bootstrap_workflow.png" src="../_images/bootstrap_workflow.png" />
</div>
</div>
<div class="section" id="build-createinstance">
<h2>Build | createinstance<a class="headerlink" href="#build-createinstance" title="Permalink to this headline">¶</a></h2>
<p>This command allows you to create a standalone instance (not attached to an AutoScale Group).
You can validate and test your module deployments and the AMI generated by <code class="docutils literal"><span class="pre">buildimage</span></code></p>
<p><strong>Command Options</strong></p>
<dl class="docutils">
<dt><em>Subnet</em> :</dt>
<dd><blockquote class="first">
<div><code class="docutils literal"><span class="pre">subnet_id</span></code></div></blockquote>
<p class="last">This option permits to choose in which subnet the instance must be created.</p>
</dd>
<dt><em>Private IP address</em> :</dt>
<dd><blockquote class="first">
<div><code class="docutils literal"><span class="pre">empty</span> <span class="pre">by</span> <span class="pre">default</span></code></div></blockquote>
<p class="last">If specified, this option permits to choose the Private IP address to affect to the created instance.</p>
</dd>
</dl>
</div>
<div class="section" id="build-destroyallinstances">
<h2>Build | destroyallinstances<a class="headerlink" href="#build-destroyallinstances" title="Permalink to this headline">¶</a></h2>
<p>This command allows you to destroy every instances mapped to the current application (based on EC2 Tags: <code class="docutils literal"><span class="pre">app</span></code>, <code class="docutils literal"><span class="pre">env</span></code>, <code class="docutils literal"><span class="pre">role</span></code>, <code class="docutils literal"><span class="pre">color</span></code>).
Both <em>standalone</em> and <em>in AutoScale</em> instances are destroyed.</p>
</div>
<div class="section" id="run-build-updateautoscaling">
<h2>Run/Build | updateautoscaling<a class="headerlink" href="#run-build-updateautoscaling" title="Permalink to this headline">¶</a></h2>
<p>This command allow you to create a new <code class="docutils literal"><span class="pre">LaunchConfiguration</span></code> with every parameter taken from the Ghost application and attach it to the AutoScale Group.
It will also update the AutoScale Group parameters (update <code class="docutils literal"><span class="pre">min</span></code>, <code class="docutils literal"><span class="pre">max</span></code>, <code class="docutils literal"><span class="pre">desired</span></code>) and tags (set needed Ghost&#8217;s tags)</p>
</div>
<div class="section" id="run-deploy">
<h2>Run | deploy<a class="headerlink" href="#run-deploy" title="Permalink to this headline">¶</a></h2>
<p>This command allows you to deploy a new configuration version or a new revision of the application.
You can choose the revision you want to deploy (git branch, tag, or hash commit).</p>
<p>Here is a workflow diagram for more details :</p>
<div class="figure">
<img alt="../_images/deploy_workflow.png" src="../_images/deploy_workflow.png" />
</div>
<p><strong>Command Options</strong></p>
<dl class="docutils">
<dt><em>Strategy</em> :</dt>
<dd><blockquote class="first">
<div><code class="docutils literal"><span class="pre">serial</span> <span class="pre">|</span> <span class="pre">parallel</span></code></div></blockquote>
<p class="last">This option permits to choose if Ghost should connect to all instances in parallel via SSH or not.</p>
</dd>
<dt><em>Safe Deploy</em> :</dt>
<dd><code class="docutils literal"><span class="pre">boolean</span> <span class="pre">and</span> <span class="pre">parameters</span></code></dd>
</dl>
<div class="section" id="safe-deploy-documentation">
<h3>Safe deploy documentation:<a class="headerlink" href="#safe-deploy-documentation" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The Safe Deployment feature aims to create a sweet way to deploy on EC2 instances. Currently when you perform a deployment with Ghost,
the instances stay in the Load Balancer&#8217;s pool during the operation even if the deployment process reload or restart a service. It&#8217;s not a really efficient and safe
because it can break user sessions and create a bad user experience.</p>
<p>It&#8217;s to tackle this problem that the safe deployment feature as been created. The vision is, for an Autoscaling Group, split the instances in multiple groups.
The feature gives the possibility to choose the split strategy of the whole AutoScaling instances and so create multiple instance groups. Each instance groups will be remove from their Load Balancer  before to
be deployed in a standard way and then registered.</p>
<p>The safe deployment feature can be used with the commands &#8220;deploy&#8221; and &#8220;redeploy&#8221; and can be used with the fabric strategy.</p>
<p>For AutoScaling Group with one or more Haproxy as Load Balancer, the safe deployment process works with Hapi only.</p>
</div></blockquote>
<p><em>The safe deployment possiblities are:</em></p>
<blockquote>
<div><blockquote>
<div><ul class="simple">
<li>1by1: Instances will be processed one after the other.</li>
<li>50%:  The whole instances will be split in 2 groups(the more equals) .</li>
<li>1/3:  The whole instances will be split in 3 groups(the more equals).</li>
<li>25%:  The whole instances will be split in 4 groups(the more equals).</li>
</ul>
</div></blockquote>
<p>The safe deployment must be configured in the application.</p>
<p>Application Parameters (In the new Load Balancer section) you can choose:</p>
<blockquote>
<div><ul class="simple">
<li>The type of the Load Balancer(ELB or Haproxy) used by this application.
(To identify the Load Balancers, if the type is an ELB, it&#8217;s the AutoScaling Group parameters which will identify them).</li>
</ul>
</div></blockquote>
<dl class="docutils">
<dt>For an HAproxy type, others informations will be required(app tag, the Haproxy backend).</dt>
<dd><ul class="first simple">
<li>The &#8220;Time to wait before deployment&#8221;(seconds) which is the time to wait after the instances deregistration process, to allow the client to finalize their requests.
(If the Load Balancer is an ELB, this value will be add to the connection draining value of the ELB)</li>
<li>The &#8220;Time to wait after deployment&#8221;(seconds) which is the time to wait after having been deployed. After this time the instances will be registered
in their Load Balancer.</li>
</ul>
<p>Only if the Load Balancer type is HAproxy:</p>
<ul class="last simple">
<li>The &#8220;HAproxy app tag&#8221; is the tag value set for the HAproxy instance which you want to associate to this application.
(The search will be performed against instances with the tags: app(this value), env(auto retrieve. Same as the application), role(fixed: &#8216;loadbalancer&#8217;))</li>
<li>The &#8220;HAProxy backend name&#8221; is the name of the backend where the instances are defined in the Haproxy configuration.</li>
<li>The &#8220;HAproxy API port&#8221; is the HAproxy API listening port.</li>
</ul>
</dd>
</dl>
<p>To activate it for a deployment, it&#8217;s on the commands side. You can used it when you &#8220;deploy&#8221; or &#8220;redeploy&#8221; a module.</p>
<dl class="docutils">
<dt>Commands Parameters:</dt>
<dd><ul class="first last simple">
<li>There is check box, &#8220;Deploy with Safe Deployment&#8221;, to activate it.</li>
<li>The parameter &#8220;Safe Deployment Strategy&#8221; will appear when the check box is checked. It shows the safe deployment possibilities(dynamically identify by the number of currently running instances).</li>
</ul>
</dd>
</dl>
<p>The process safe deployment process is:</p>
<blockquote>
<div><ul class="simple">
<li>Check that every instances in the Load Balancer(ELB or HAproxy) are in service and are enough to perform the safe deployment and check also, when there are multiple Load Balancers, that they have the same configuration.</li>
<li>Split the instances list in groups according the deployment type choosen(1by1-1/3-25%-50%).</li>
<li>Before begin to deploy on the instances group, remove them from their Load Balancer(Haproxy or ELB)</li>
<li>Wait a moment(depends on the connection draining value for the ELB and/or the custom value defines in Ghost)</li>
<li>Launch the standard deployment process</li>
<li>Wait a moment(depends on the custom value defines in Ghost)</li>
<li>Add the updated instances in their Load Balancer.</li>
<li>Wait until instances become healthly(checked every 10s).</li>
<li>Do the same process for the next instance groups.</li>
</ul>
</div></blockquote>
</div></blockquote>
<p>Example of safe deployment output:</p>
<blockquote>
<div><blockquote>
<div><ul class="simple">
<li>Suspending auto-scaling group processes [&#8216;Terminate&#8217;, &#8216;Launch&#8217;]</li>
<li>Instances [u&#8217;i-87bc5b05&#8217;, u&#8217;i-87bcei97&#8217;] well deregistered in the ELB test</li>
<li>Waiting 15s: The connection draining time more the custom value set for wait_before_deploy</li>
<li>Updating current instances in serial: [u&#8216;10.10.12.80&#8217;, u&#8216;10.10.11.50&#8217;]</li>
<li>Waiting 10s: The value set for wait_after_deploy</li>
<li>Instances [u&#8217;i-87bc5b05&#8217;, u&#8217;i-87bcei97&#8217;] well registered in the ELB test</li>
<li>Waiting 10s because the instance is not in service in the ELB</li>
<li>Waiting 10s because the instance is not in service in the ELB</li>
<li>Instances: [u&#8216;10.10.10.189&#8217;, u&#8216;10.10.11.50&#8217;] have been deployed and are registered in their ELB</li>
<li>...</li>
<li>... (same process for the others safe deployment groups)</li>
<li>...</li>
<li>Resuming auto-scaling group processes [&#8216;Terminate&#8217;, &#8216;Launch&#8217;]</li>
</ul>
</div></blockquote>
<p>In case of failure during the safe deployment process, if the instances were disabled/deregistered from their Load Balancer, they stay in this state. At the next deploy/redeploy action, a new complet deployment will be performed on them and if no error occurs, they will be enabled/registered in their Load Balancer.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="run-redeploy">
<h2>Run | redeploy<a class="headerlink" href="#run-redeploy" title="Permalink to this headline">¶</a></h2>
<p>This commands allows you to deploy an old version that has already been deployed in the past. This command is usefull in order to rollback a bad deployment of an application or a system configuration.</p>
<p>When you choose to use this command, you have to specify which deployment you want to re-deploy.
Ghost will bring back this archive (generated by the <code class="docutils literal"><span class="pre">buildpack</span></code> step from the <code class="docutils literal"><span class="pre">deploy</span></code> command) and execute the half second part of the <code class="docutils literal"><span class="pre">deploy</span></code> workflow:</p>
<blockquote>
<div><ul class="simple">
<li>Executes pre deploy script</li>
<li>Symlink the deployment content</li>
<li>Executes post deploy script</li>
<li>Notification (by mail)</li>
</ul>
</div></blockquote>
<p>Please see <strong>Run | deploy</strong> for more details.</p>
</div>
<div class="section" id="blue-green-preparebluegreen">
<h2>Blue/Green | preparebluegreen<a class="headerlink" href="#blue-green-preparebluegreen" title="Permalink to this headline">¶</a></h2>
<p>This commands is the first step in the <code class="docutils literal"><span class="pre">Blue/Green</span></code> deployment process.
It will duplicate the actual <strong>online</strong> Elastic Load Balancer to create a temporary one and attach this temporary ELB to the <strong>stand by</strong> AutoScale Group.
It will also update the <strong>stand by</strong> AutoScale Group (Please see <strong>Run/Build | updateautoscaling</strong> for more details.)
After this command, you can update the <strong>stand by</strong> env by trigerring <code class="docutils literal"><span class="pre">buildimage</span></code> and <code class="docutils literal"><span class="pre">deploy</span></code> commands.</p>
<p><strong>Command Options</strong></p>
<dl class="docutils">
<dt><em>Copy AMI</em> :</dt>
<dd><blockquote class="first">
<div><code class="docutils literal"><span class="pre">boolean</span></code></div></blockquote>
<p class="last">This option permits to duplicate the AMI id from the <strong>online</strong> AutoScale Group when updating the <strong>stand by</strong> AutoScale Group.</p>
</dd>
</dl>
</div>
<div class="section" id="blue-green-swapbluegreen">
<h2>Blue/Green | swapbluegreen<a class="headerlink" href="#blue-green-swapbluegreen" title="Permalink to this headline">¶</a></h2>
<p>This commands is the main step in the <code class="docutils literal"><span class="pre">Blue/Green</span></code> deployment process.
It will swap the two version of the application by swapping the <code class="docutils literal"><span class="pre">blue</span></code> and <code class="docutils literal"><span class="pre">green</span></code> env.</p>
<p><strong>Command Options</strong></p>
<dl class="docutils">
<dt><em>Swap strategy</em> :</dt>
<dd><p class="first"><code class="docutils literal"><span class="pre">overlap</span> <span class="pre">|</span> <span class="pre">isolated</span></code></p>
<blockquote class="last">
<div><p>This is the Blue/Green swap strategy to choose:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">overlap</span></code>: Default behavior. There is no downtime of service with this strategy but both version of the application could be online at the same time because the <strong>N+1</strong> version will be attached to the <strong>online</strong> ELB before the <strong>N</strong> version is detached.</li>
<li><code class="docutils literal"><span class="pre">isolated</span></code>: This strategy will produce a downtime of service but ensures that only one version of the application is online.</li>
</ul>
</div></blockquote>
</div></blockquote>
</dd>
</dl>
</div>
<div class="section" id="blue-green-purgebluegreen">
<h2>Blue/Green | purgebluegreen<a class="headerlink" href="#blue-green-purgebluegreen" title="Permalink to this headline">¶</a></h2>
<p>This commands is the last step in the <code class="docutils literal"><span class="pre">Blue/Green</span></code> deployment process.
It will purge the <strong>stand by</strong> env by deleting the temporary ELB, updating the stand by AutoScale Group and destroying every instances for this env. (Please see <strong>Build | destroyallinstances</strong> for more details.)</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="scripts.html" class="btn btn-neutral float-right" title="Ghost Scripts" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="api.html" class="btn btn-neutral" title="Ghost API" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Morea Team - Claranet.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'16.12',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>